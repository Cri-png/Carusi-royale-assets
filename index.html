<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Clash Fangame</title>
    <link rel="stylesheet" href="./style_base.css">
    <link rel="stylesheet" href="./style_components.css">
    <link rel="stylesheet" href="./style_lobby.css">
    <link rel="stylesheet" href="./style_game.css">
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.165.0",
                "three/addons/": "https://esm.sh/three@0.165.0/examples/jsm/",
                "howler": "https://esm.sh/howler@2.2.4" 
            }
        }
    </script>
</head>
<body>
    <div id="loading-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 24px; z-index: 100; font-family: sans-serif;">
        <div id="loading-text" style="margin-bottom: 20px;">Loading Assets... 0%</div>
        <div style="width: 200px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-bottom: 10px;">
            <div id="loading-bar" style="width: 0%; height: 100%; background: #00ff00; transition: width 0.2s;"></div>
        </div>
        <div id="loading-subtext" style="font-size: 14px; color: #888;">Preparing game data...</div>
        <button id="skip-loading-btn" style="margin-top: 30px; padding: 10px 20px; background: rgba(255,255,255,0.1); color: #aaa; border: 1px solid #555; cursor: pointer; border-radius: 5px; font-family: sans-serif; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; transition: background 0.2s;">Skip 3D Models</button>
    </div>

    <!-- Intro Splash Screen -->
    <div id="intro-splash" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #2a0845, #182848); z-index: 95; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; cursor: pointer;">
        <div class="logo-container" style="animation: float 3s ease-in-out infinite;">
            <h1 style="font-size: 64px; font-weight: 900; margin: 0; background: linear-gradient(to bottom, #ffea00, #ffae00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 5px 0 #b85e00); text-transform: uppercase; letter-spacing: 4px; transform: skewX(-10deg);">CLASH</h1>
            <h2 style="font-size: 42px; font-weight: 900; margin: -10px 0 0 0; color: #fff; text-shadow: 0 0 20px rgba(156, 39, 176, 0.8); text-transform: uppercase;">CARUSI</h2>
        </div>
        <div class="tap-hint" style="margin-top: 50px; font-size: 18px; font-weight: bold; letter-spacing: 2px; color: #ffd700; text-transform: uppercase; animation: pulse 1.5s infinite;">Tap to Enter</div>
    </div>

    <!-- New Player Welcome screen -->
    <div id="welcome-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 96; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; font-family: sans-serif;">
        <h2 style="margin-bottom: 30px; font-size: 28px; text-transform: uppercase; color: gold;">Welcome, Challenger!</h2>
        <div style="background: #222; padding: 30px; border-radius: 20px; border: 2px solid #444; width: 80%; max-width: 350px; text-align: center;">
            <p style="color: #aaa; margin-bottom: 20px;">What should we call you in the arena?</p>
            <input type="text" id="welcome-username-input" placeholder="USERNAME" maxlength="12" style="width: 100%; padding: 15px; font-size: 20px; text-align: center; border-radius: 10px; border: 2px solid #555; background: #000; color: #fff; text-transform: uppercase; letter-spacing: 2px; box-sizing: border-box;">
            <button id="welcome-confirm-btn" class="result-btn" style="width: 100%; margin-top: 25px; padding: 15px; font-size: 18px;">START JOURNEY</button>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby-screen">
        <div class="lobby-bg-pattern"></div>
        
        <!-- Top Bar -->
        <div class="header-bar">
            <div class="player-info">
                <div class="avatar"></div>
                <span style="margin-right: 15px;">Player</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <div style="color: gold; font-weight: bold; display: flex; align-items: center; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 15px;">
                     <span style="font-size: 16px;">üí∞</span> <span id="gold-display" style="margin-left: 5px;">0</span>
                </div>
                <div style="color: #00ff88; font-weight: bold; display: flex; align-items: center; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 15px;">
                     <span style="font-size: 16px;">üíé</span> <span id="gems-display" style="margin-left: 5px;">0</span>
                </div>
                <div id="settings-btn" style="color: #ccc; font-weight: bold; display: flex; align-items: center; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 15px; cursor: pointer;">
                     <span style="font-size: 16px;">‚öôÔ∏è</span>
                </div>
            </div>
        </div>

        <!-- Shop Tab -->
        <div id="shop-tab" class="tab-content">
            <div class="shop-section-title">Daily Deals</div>
            <div class="chest-container">
                <div class="chest-card" id="free-chest">
                    <div class="chest-icon" style="background: #8d6e63;"></div>
                    <div style="color: #81c784; font-weight: bold;">FREE</div>
                    <div style="font-size: 12px; color: #ccc;">Free Chest</div>
                </div>
                
                <div class="chest-card" id="lucky-chest">
                    <div class="chest-icon" style="background: #fdd835; border: 2px solid orange;"></div>
                    <div style="color: gold; font-weight: bold;">AD</div>
                    <div style="font-size: 12px; color: #ccc;">Lucky Chest</div>
                    <div style="font-size: 10px; color: #aaa; margin-top: 5px;">Tap 4x to Upgrade!</div>
                </div>
                
                <div class="chest-card" id="evo-chest">
                    <div class="chest-icon" style="background: #9c27b0; border: 2px solid #e040fb; filter: hue-rotate(280deg);"></div>
                    <div style="color: #e040fb; font-weight: bold;">EVO</div>
                    <div style="font-size: 12px; color: #ccc;">Evo Chest</div>
                    <div style="font-size: 10px; color: #aaa; margin-top: 5px;">Starts at 3 Stars!</div>
                </div>
            </div>
            
            <button id="catalogue-btn" class="result-btn" style="width: 80%; margin: 30px auto; display: block; background: linear-gradient(to right, #4a148c, #7b1fa2); border: 2px solid #e040fb;">
                üìñ Shard Catalogue
            </button>
        </div>

        <!-- Battle Tab -->
        <div id="battle-tab" class="tab-content active">
            <div id="game-title">Battle Tactics</div>
            
            <div style="position: relative;">
                <button id="play-btn">Battle</button>
                <div id="match-finding">
                    <div class="loading-spinner"></div>
                    Searching...
                </div>
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <div style="color: #aaa; margin-bottom: 10px; font-weight: bold; text-transform: uppercase; font-size: 12px; letter-spacing: 1px;">Battle Deck</div>
                <div class="deck-preview" id="lobby-deck-preview">
                    <!-- Cards injected via JS -->
                </div>
            </div>
        </div>

        <!-- Collection Tab -->
        <div id="collection-tab" class="tab-content">
            <div class="shop-section-title" style="text-align: center; border: none;">Card Collection</div>
            <div class="card-grid" id="collection-grid">
                <!-- Cards injected via JS -->
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="nav-tabs">
            <div class="nav-tab" data-target="shop-tab">
                <div class="nav-icon">üè™</div>
                Shop
            </div>
            <div class="nav-tab active" data-target="battle-tab">
                <div class="nav-icon">‚öîÔ∏è</div>
                Battle
            </div>
            <div class="nav-tab" data-target="collection-tab">
                <div class="nav-icon">üé¥</div>
                Cards
            </div>
        </div>
    </div>
    
    <!-- Generic Modal -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content" id="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Match Intro Overlay -->
    <div id="match-intro">
        <div class="intro-player" id="intro-p1">Player</div>
        <div class="intro-vs">VS</div>
        <div class="intro-player" id="intro-p2" style="border-color: #ff4444;">Bot</div>
    </div>

    <!-- Match Result Overlay -->
    <div id="match-result">
        <div class="result-title" id="result-title">VICTORY!</div>
        <div class="crown-display">
            <div class="crown">üëë</div>
            <div class="crown">üëë</div>
            <div class="crown">üëë</div>
        </div>
        <button class="result-btn" id="result-ok-btn">OK</button>
    </div>

    <!-- Evolution Unlock Overlay -->
    <div id="evo-unlock-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 300; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.5s;">
        <div style="font-size: 36px; font-weight: 900; color: #e040fb; text-shadow: 0 0 20px #9c27b0; margin-bottom: 20px; text-transform: uppercase; animation: pulse 1s infinite;">Evolution Unlocked!</div>
        <div id="evo-unlock-card" style="width: 200px; height: 240px; background-size: cover; background-position: center; border: 4px solid #e040fb; border-radius: 15px; box-shadow: 0 0 50px #9c27b0; position: relative;">
            <div class="evo-diamond" style="top: -15px; width: 40px; height: 40px; font-size: 24px;"><span>E</span></div>
        </div>
        <button id="evo-unlock-close" class="result-btn" style="margin-top: 40px; background: linear-gradient(to right, #7b1fa2, #4a148c);">AWESOME!</button>
    </div>

    <div id="app" style="opacity: 0;">
        <div id="health-labels-2d"></div>
        
        <!-- Game HUD Wrapper -->
        <div id="game-hud">
            <div id="match-timer">02:00</div>
            <div id="double-elixir-icon">2x</div>
            
            <div id="elixir-container" style="position: absolute; bottom: 90px; width: 100%; display: flex; justify-content: center; pointer-events: none; z-index: 20;">
                 <div style="background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; border: 2px solid #b000b0; color: white; font-weight: bold; font-family: sans-serif; font-size: 20px; display: flex; align-items: center; text-shadow: 1px 1px 2px black;">
                    <div style="width: 15px; height: 20px; background: #d000d0; margin-right: 8px; clip-path: polygon(50% 0%, 100% 35%, 82% 100%, 18% 100%, 0% 35%);"></div>
                    <span id="elixir-display">5</span>
                 </div>
            </div>
    
            <div id="emote-button-container" style="position: absolute; bottom: 15px; right: 10px; z-index: 22; pointer-events: auto;">
                 <button id="emote-btn" style="width: 50px; height: 50px; border-radius: 50%; background: #4a148c; border: 3px solid #fff; color: white; font-size: 30px; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 10px rgba(0,0,0,0.5);">...</button>
            </div>

            <div id="next-card-container" style="position: absolute; bottom: 90px; left: 10px; width: 60px; height: 75px; background: rgba(0,0,0,0.6); border: 2px solid #333; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; z-index: 20;">
                <span style="color: #ccc; font-family: sans-serif; font-size: 10px; font-weight: bold; margin-bottom: 2px; text-transform: uppercase;">Next</span>
                <div id="next-card-icon" style="width: 45px; height: 45px; background-color: rgba(0,0,0,0.3); border: 1px solid #555; border-radius: 4px; background-size: cover; background-position: center;"></div>
            </div>
    
            <div id="card-ui">
                <!-- Cards will be generated via JS -->
            </div>

            <!-- Emote Selection Panel -->
            <div id="emote-selection-panel" style="position: absolute; bottom: 75px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; display: none; flex-direction: column; gap: 10px; z-index: 23; pointer-events: auto;">
                <div class="emote-option" data-emote="GiantIceBreaker" style="width: 50px; height: 50px; border-radius: 8px; background-color: #00bcd4; display: flex; justify-content: center; align-items: center; cursor: pointer;"></div>
            </div>

            <!-- Emote Display Layer -->
            <div id="emote-display-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 30;">
                 <!-- Emotes are dynamically placed here -->
            </div>
        </div>
    </div>
    <script type="module" src="./main.js"></script>
    <!-- Username Modal (Legacy/Initial) -->
    <div id="username-modal" class="modal-overlay" style="z-index: 200;">
        <div class="modal-content" style="max-width: 300px;">
            <h2>Who are you?</h2>
            <input type="text" id="username-input" placeholder="Enter Username" maxlength="12" style="width: 80%; padding: 10px; font-size: 18px; text-align: center; margin: 20px 0; border-radius: 5px; border: 1px solid #555; background: #333; color: white;">
            <button id="save-username-btn" class="result-btn" style="width: 100%;">Confirm</button>
        </div>
    </div>

    <!-- Multiplayer Modal -->
    <div id="multiplayer-modal" class="modal-overlay">
        <div class="modal-content" style="min-height: 300px; display: flex; flex-direction: column; justify-content: center;">
            <span class="modal-close" id="mp-close">&times;</span>
            <h2 style="margin-top: 0;">1v1 Battle</h2>
            
            <!-- Initial View -->
            <div id="mp-menu-view">
                <button id="mp-create-btn" class="result-btn" style="width: 100%; margin-bottom: 20px; background: linear-gradient(to bottom, #4CAF50, #2E7D32); box-shadow: 0 4px 0 #1B5E20;">CREATE ROOM</button>
                
                <div style="margin: 15px 0; color: #aaa; font-size: 14px;">- OR JOIN ROOM -</div>
                
                <input type="text" id="room-code-input" placeholder="ENTER CODE" maxlength="4" style="padding: 15px; font-size: 24px; border-radius: 8px; border: 2px solid #555; background: #222; color: white; text-align: center; width: 80%; text-transform: uppercase; margin-bottom: 15px; font-family: monospace; letter-spacing: 2px;">
                <button id="mp-join-btn" class="result-btn" style="width: 100%; font-size: 18px; padding: 10px 30px;">JOIN MATCH</button>
            </div>

            <!-- Waiting View -->
            <div id="mp-waiting-view" style="display: none; animation: fadeIn 0.3s;">
                <div style="color: #ccc; margin-bottom: 10px;">Share this code with your friend:</div>
                <div id="generated-code-display" style="font-size: 48px; font-weight: 900; color: #ffd700; letter-spacing: 5px; margin: 20px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-family: monospace; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px;">----</div>
                <div class="loading-spinner"></div>
                <div id="mp-status" style="margin: 15px 0; color: #ccc; font-weight: bold; min-height: 20px;">Waiting for opponent...</div>
                <button id="mp-cancel-btn" class="result-btn" style="font-size: 14px; padding: 8px 20px; margin-top: 10px; background: #555; box-shadow: 0 4px 0 #333;">CANCEL</button>
            </div>
        </div>
    </div>
</body>
</html>

